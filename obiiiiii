@app.get("/save/<loadid>")
def save_load_id(loadid: str):
    try:
        # 1. Get the connection string manually to ensure it's loaded
        conn_str = os.getenv("BLOB_CONNECTION_STRING")
        if not conn_str:
            return jsonify({"status": "error", "detail": "Connection string not found in .env"}), 500

        service_client = BlobServiceClient.from_connection_string(conn_str)
        
        # 2. Specifically target the 'inbound' container to get your file
        inbound_client = service_client.get_container_client("inbound")
        
        # We search for the file you have: parse_pbp_files.csv
        blob_in_name = f"{loadid}.csv" 
        blob_in = inbound_client.download_blob(blob_in_name)
        raw_data = blob_in.readall().decode("utf-8")

        # 3. Process the data using your script
        processed_csv = process_data(raw_data)

        # 4. Specifically target the 'outbound' container to save
        outbound_client = service_client.get_container_client("outbound")
        timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
        output_name = f"{loadid}/{timestamp}/{loadid}_results.csv"
        
        outbound_client.upload_blob(name=output_name, data=processed_csv, overwrite=True)

        return jsonify({"status": "success", "saved_to": output_name})

    except Exception as e:
        return jsonify({"status": "error", "detail": str(e)}), 500
