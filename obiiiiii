import io
from run_process import process_data  # Ensure your function name matches in run_process.py

@app.get("/save/<loadid>")
def save_load_id(loadid: str):
    try:
        # Get connection string and initialize client
        conn_str = os.getenv("BLOB_CONNECTION_STRING")
        service_client = BlobServiceClient.from_connection_string(conn_str)
        
        # 1. Setup specific container clients
        inbound_client = service_client.get_container_client("inbound")
        outbound_client = service_client.get_container_client("outbound")

        # 2. Download from Inbound (assuming file is named loadid.csv)
        # We use readall() to keep it in memory
        blob_name_in = f"{loadid}.csv"
        input_data = inbound_client.download_blob(blob_name_in).readall().decode("utf-8")

        # 3. Pass data to your modularized process script
        # This function should take the CSV string and return the result CSV string
        processed_csv_content = process_data(input_data)

        # 4. Generate the path: loadid/timestamp/loadid_results.csv
        timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
        blob_name_out = f"{loadid}/{timestamp}/{loadid}_results.csv"

        # 5. Save to Outbound
        outbound_client.upload_blob(
            name=blob_name_out,
            data=processed_csv_content,
            overwrite=True
        )

        return jsonify({
            "status": "success",
            "loadid": loadid,
            "saved_to": f"outbound/{blob_name_out}",
            "timestamp": timestamp
        })

    except Exception as e:
        # Keep your existing error handling from the screenshot
        return jsonify({"status": "error", "detail": str(e)}), 500




import pandas as pd
import io

def process_data(csv_string):
    # Read the string into a DataFrame
    df = pd.read_csv(io.StringIO(csv_string))
    
    # --- YOUR PROCESSING LOGIC HERE ---
    # Example: results = df.groupby('something').sum()
    results = df 
    
    # Convert DataFrame back to a CSV string
    output = io.StringIO()
    results.to_csv(output, index=False)
    return output.getvalue()
